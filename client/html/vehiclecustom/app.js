const json = `[{"index":0,"numMods":20,"modLabels":[{"displayName":"Short Lip Spoiler","index":0},{"displayName":"Extended Lip Spoiler","index":1},{"displayName":"Bolt-On Ducktail","index":2},{"displayName":"Drag Spoiler","index":3},{"displayName":"Stock Car Spoiler","index":4},{"displayName":"Mid Level Spoiler","index":5},{"displayName":"Carbon Flap Spoiler","index":6},{"displayName":"Low Spoiler","index":7},{"displayName":"Low Carbon Spoiler","index":8},{"displayName":"Classic RS Wing","index":9},{"displayName":"Carbon Classic RS Wing","index":10},{"displayName":"Tuner Wing","index":11},{"displayName":"Carbon Wing Type II","index":12},{"displayName":"Extreme Downforce BGW","index":13},{"displayName":"Muscle Killer Wing","index":14},{"displayName":"Drift Wing","index":15},{"displayName":"GT Wing","index":16},{"displayName":"Tarmac Attack Wing","index":17},{"displayName":"Extreme Street Racer Wing","index":18},{"displayName":"Extreme Time Attack Wing","index":19}],"slotName":"Spoiler"},{"index":1,"numMods":6,"modLabels":[{"displayName":"Stickerbomb Splitter","index":0},{"displayName":"Carbon Front Splitter","index":1},{"displayName":"Painted Extended Splitter","index":2},{"displayName":"Black Extended Splitter","index":3},{"displayName":"Extended Front Diffuser","index":4},{"displayName":"Splitter With Canards","index":5}],"slotName":"TOP_BUMF"},{"index":2,"numMods":3,"modLabels":[{"displayName":"Carbon Rear Diffuser","index":0},{"displayName":"Carbon Track Diffuser","index":1},{"displayName":"Carbon Race Diffuser","index":2}],"slotName":"TOP_BUMR"},{"index":3,"numMods":5,"modLabels":[{"displayName":"Sideskirt Extensions","index":0},{"displayName":"Secondary Skirt Extensions","index":1},{"displayName":"Carbon Skirt Extensions","index":2},{"displayName":"Drift Skirts","index":3},{"displayName":"Secondary Drift Skirts","index":4}],"slotName":"Skirt"},{"index":4,"numMods":9,"modLabels":[{"displayName":"Chrome Tip Exhaust","index":0},{"displayName":"Big Bore Exhaust","index":1},{"displayName":"Race Exhaust","index":2},{"displayName":"Oval Exhaust","index":3},{"displayName":"Titanium Exhaust","index":4},{"displayName":"Titanium Tuner Exhaust","index":5},{"displayName":"Twin Chrome Tip Exhaust","index":6},{"displayName":"Twin Titanium Exhaust","index":7},{"displayName":"Twin Titanium Tuner Exhaust","index":8}],"slotName":"Exhaust"},{"index":5,"numMods":5,"modLabels":[{"displayName":"Street Half Cage","index":0},{"displayName":"Dash Dodger Cage","index":1},{"displayName":"Padded Dash Dodger Cage","index":2},{"displayName":"Full Roll Cage","index":3},{"displayName":"Padded Full Roll Cage","index":4}],"slotName":"Chassis"},{"index":6,"numMods":3,"modLabels":[{"displayName":"Secondary Grille Surround","index":0},{"displayName":"Black Grille Surround","index":1},{"displayName":"Carbon Grille Surround","index":2}],"slotName":"Grill"},{"index":7,"numMods":12,"modLabels":[{"displayName":"Stickerbomb Hood","index":0},{"displayName":"Ducted Hood","index":1},{"displayName":"Vented Hood","index":2},{"displayName":"Double Vented Hood","index":3},{"displayName":"Performance Hood","index":4},{"displayName":"Raised Extreme Hood","index":5},{"displayName":"Carbon Hood","index":6},{"displayName":"Carbon Ducted Hood","index":7},{"displayName":"Carbon Vented Hood","index":8},{"displayName":"Carbon Double Vented Hood","index":9},{"displayName":"Carbon Performance Hood","index":10},{"displayName":"Carbon Extreme Hood","index":11}],"slotName":"Bonnet"},{"index":8,"numMods":6,"modLabels":[{"displayName":"Single Vent Front Fenders","index":0},{"displayName":"Twin Vent Front Fenders","index":1},{"displayName":"Wide Angular Rear Fenders","index":2},{"displayName":"Primary Color Bolt-On Arches","index":3},{"displayName":"Secondary Color Bolt-On Arches","index":4},{"displayName":"Carbon Bolt-On Arches","index":5}],"slotName":"Left Wing"},{"index":10,"numMods":7,"modLabels":[{"displayName":"Roof Spoiler","index":0},{"displayName":"Carbon Roof Spoiler","index":1},{"displayName":"Vortex Generators","index":2},{"displayName":"Carbon Vortex Generators","index":3},{"displayName":"Carbon Roof","index":4},{"displayName":"Carbon & Roof Spoiler","index":5},{"displayName":"Carbon & Vortex Generators","index":6}],"slotName":"Roof"},{"index":23,"numMods":50,"modLabels":[{"displayName":"Inferno","index":0},{"displayName":"Deep Five","index":1},{"displayName":"Lozspeed Mk.V","index":2},{"displayName":"Diamond Cut","index":3},{"displayName":"Chrono","index":4},{"displayName":"Feroci RR","index":5},{"displayName":"FiftyNine","index":6},{"displayName":"Mercie","index":7},{"displayName":"Synthetic Z","index":8},{"displayName":"Organic Type 0","index":9},{"displayName":"Endo v.1","index":10},{"displayName":"GT One","index":11},{"displayName":"Duper 7","index":12},{"displayName":"Uzer","index":13},{"displayName":"GroundRide","index":14},{"displayName":"S Racer","index":15},{"displayName":"Venum","index":16},{"displayName":"Cosmo","index":17},{"displayName":"Dash VIP","index":18},{"displayName":"Ice Kid","index":19},{"displayName":"Ruff Weld","index":20},{"displayName":"Wangan Master","index":21},{"displayName":"Super Five","index":22},{"displayName":"Endo v.2","index":23},{"displayName":"Split Six","index":24},{"displayName":"Inferno","index":25},{"displayName":"Deep Five","index":26},{"displayName":"Lozspeed Mk.V","index":27},{"displayName":"Diamond Cut","index":28},{"displayName":"Chrono","index":29},{"displayName":"Feroci RR","index":30},{"displayName":"FiftyNine","index":31},{"displayName":"Mercie","index":32},{"displayName":"Synthetic Z","index":33},{"displayName":"Organic Type 0","index":34},{"displayName":"Endo v.1","index":35},{"displayName":"GT One","index":36},{"displayName":"Duper 7","index":37},{"displayName":"Uzer","index":38},{"displayName":"GroundRide","index":39},{"displayName":"S Racer","index":40},{"displayName":"Venum","index":41},{"displayName":"Cosmo","index":42},{"displayName":"Dash VIP","index":43},{"displayName":"Ice Kid","index":44},{"displayName":"Ruff Weld","index":45},{"displayName":"Wangan Master","index":46},{"displayName":"Super Five","index":47},{"displayName":"Endo v.2","index":48},{"displayName":"Split Six","index":49}],"slotName":null},{"index":25,"numMods":3,"modLabels":[{"displayName":"Remove Front Plate","index":0},{"displayName":"Left Mounted Front Plate","index":1},{"displayName":"Right Mounted Front Plate","index":2}],"slotName":""},{"index":26,"numMods":4,"modLabels":[{"displayName":"Debadged Grille","index":0},{"displayName":"Remove Grille Mesh","index":1},{"displayName":"Remove Bumper Mesh","index":2},{"displayName":"Remove Grille & Bumper Mesh","index":3}],"slotName":""},{"index":27,"numMods":1,"modLabels":[{"displayName":"Sunstrip","index":0}],"slotName":""},{"index":29,"numMods":5,"modLabels":[{"displayName":"Street Interior","index":0},{"displayName":"Semi Stripped Interior","index":1},{"displayName":"Race Dash & Stripped Interior","index":2},{"displayName":"Flocked Dash & Stripped","index":3},{"displayName":"Carbon Dash & Stripped Interior","index":4}],"slotName":""},{"index":30,"numMods":15,"modLabels":[{"displayName":"Pod Mounted Tacho","index":0},{"displayName":"Cluster Mounted Tacho","index":1},{"displayName":"Pod Tacho & Glovebox Gauges","index":2},{"displayName":"Tacho & Glovebox Gauges","index":3},{"displayName":"Pod Tacho & Dash Gauges","index":4},{"displayName":"Tacho & Dash Gauges","index":5},{"displayName":"Race Display","index":6},{"displayName":"Race Display & Glovebox","index":7},{"displayName":"Race Display & Dash Gauges","index":8},{"displayName":"Mk2 Race Display","index":9},{"displayName":"Mk2 Display & Glovebox Gauges","index":10},{"displayName":"Mk2 Display & Dash Gauges","index":11},{"displayName":"Mk3 Race Display","index":12},{"displayName":"Mk3 Display & Glovebox Gauges","index":13},{"displayName":"Mk3 Display & Dash Gauges","index":14}],"slotName":""},{"index":31,"numMods":7,"modLabels":[{"displayName":"Carbon Doorcards","index":0},{"displayName":"Aluminum Panel Doorcards","index":1},{"displayName":"Carbon Panel Doorcards","index":2},{"displayName":"Primary Color Doorcards","index":3},{"displayName":"Secondary Color Doorcards","index":4},{"displayName":"Aluminum Race Doorcards","index":5},{"displayName":"Carbon Race Doorcards","index":6}],"slotName":""},{"index":32,"numMods":14,"modLabels":[{"displayName":"Sports Seats","index":0},{"displayName":"Painted Sports Seats","index":1},{"displayName":"Carbon Sports Seats","index":2},{"displayName":"Ballistic Fibre Sports Seats","index":3},{"displayName":"Painted Tuner Seats","index":4},{"displayName":"Carbon Tuner Seats","index":5},{"displayName":"Ballistic Fibre Tuner Seats","index":6},{"displayName":"Painted Bucket Seats","index":7},{"displayName":"Carbon Bucket Seats","index":8},{"displayName":"Ballistic Fibre Bucket Seats","index":9},{"displayName":"Painted Track Seats","index":10},{"displayName":"Carbon Track Seats","index":11},{"displayName":"Ballistic Fibre Track Seats","index":12},{"displayName":"Carbon Race Seats","index":13}],"slotName":""},{"index":33,"numMods":16,"modLabels":[{"displayName":"Apex Basic","index":0},{"displayName":"Apex Clubman","index":1},{"displayName":"Apex Professional","index":2},{"displayName":"Formula Basic","index":3},{"displayName":"Formula Cutout","index":4},{"displayName":"Formula Clubman","index":5},{"displayName":"Formula Professional","index":6},{"displayName":"Sprint Basic","index":7},{"displayName":"Sprint Clubman","index":8},{"displayName":"Sprint MKII","index":9},{"displayName":"Sprint Lightweight","index":10},{"displayName":"Sprint Featherweight","index":11},{"displayName":"Sprint Professional","index":12},{"displayName":"Rally Basic","index":13},{"displayName":"Rally Clubman","index":14},{"displayName":"Rally Professional","index":15}],"slotName":""},{"index":39,"numMods":4,"modLabels":[{"displayName":"Primary Color Valve Covers","index":0},{"displayName":"Secondary Color Valve Covers","index":1},{"displayName":"Polished Valve Covers","index":2},{"displayName":"Carbon Valve Covers","index":3}],"slotName":""},{"index":40,"numMods":8,"modLabels":[{"displayName":"Primary Color Cambelt Cover","index":0},{"displayName":"Secondary Color Cambelt Cover","index":1},{"displayName":"Polished Cambelt Cover","index":2},{"displayName":"Carbon Cambelt Cover","index":3},{"displayName":"Black Exposed Vernier Pulleys","index":4},{"displayName":"Blue Exposed Vernier Pulleys","index":5},{"displayName":"Red Exposed Vernier Pulleys","index":6},{"displayName":"Purple Exposed Vernier Pulleys","index":7}],"slotName":""},{"index":41,"numMods":12,"modLabels":[{"displayName":"Polished Strut Brace","index":0},{"displayName":"Carbon Strut Brace","index":1},{"displayName":"Medium Polished Strut Brace","index":2},{"displayName":"Medium Titanium Strut Brace","index":3},{"displayName":"Titanium Strut Brace","index":4},{"displayName":"Triangulated Strut Brace","index":5},{"displayName":"Wide Titanium Strut Brace","index":6},{"displayName":"Large Polished Strut Brace","index":7},{"displayName":"Stickerbomb Strut Brace","index":8},{"displayName":"Polished Twin Bar Strut Brace","index":9},{"displayName":"Extreme Billet Strut Brace","index":10},{"displayName":"Lightened Racing Strut Brace","index":11}],"slotName":""},{"index":42,"numMods":6,"modLabels":[{"displayName":"Painted Headlight Duct","index":0},{"displayName":"Carbon Headlight Duct","index":1},{"displayName":"Painted Duct & Plated Light","index":2},{"displayName":"Carbon Duct & Plated Light","index":3},{"displayName":"Twin Painted Headlight Ducts","index":4},{"displayName":"Twin Carbon Headlight Ducts","index":5}],"slotName":""},{"index":43,"numMods":11,"modLabels":[{"displayName":"Painted Hood Lip","index":0},{"displayName":"Carbon Hood Lip","index":1},{"displayName":"Chrome Hood Catches","index":2},{"displayName":"Angled Hood Catches","index":3},{"displayName":"Straight Hood Catches","index":4},{"displayName":"Lip & Chrome Catches","index":5},{"displayName":"Lip & Angled Catches","index":6},{"displayName":"Lip & Straight Catches","index":7},{"displayName":"Carbon Lip & Chrome Catches","index":8},{"displayName":"Carbon Lip & Angled Catches","index":9},{"displayName":"Carbon Lip & Straight Catches","index":10}],"slotName":""},{"index":44,"numMods":2,"modLabels":[{"displayName":"Roof Vent","index":0},{"displayName":"Carbon Vent","index":1}],"slotName":""},{"index":45,"numMods":5,"modLabels":[{"displayName":"Intercooler With Twin Fans","index":0},{"displayName":"Monster Intercooler","index":1},{"displayName":"Intercooler With Water Sprayer","index":2},{"displayName":"Logo Intercooler","index":3},{"displayName":"Logo Monster Intercooler","index":4}],"slotName":""},{"index":46,"numMods":2,"modLabels":[{"displayName":"Painted Wind Deflectors","index":0},{"displayName":"Carbon Wind Deflectors","index":1}],"slotName":""},{"index":48,"numMods":9,"modLabels":[{"displayName":"White Stripes","index":0},{"displayName":"Black Stripes","index":1},{"displayName":"Not Tonight Pizzaboy","index":2},{"displayName":"Midnight Racer","index":3},{"displayName":"Battle Damaged","index":4},{"displayName":"Drift Missile","index":5},{"displayName":"Redwood Racing","index":6},{"displayName":"LTD Gasoline","index":7},{"displayName":"Meinmacht","index":8}],"slotName":""}]`;

const { createElement, render, Component } = preact;
// import { Scrollbars } from preact-custom-scrollbars;
const h = createElement;

class App extends Component {
    constructor(props) {
        super(props);
        this.state = {
            mods: [],
            primary: [0, 0, 0],
            secondary: [0, 0, 0],
            primaryPaintType: 0,
            secondaryPaintType: 0
        };
        this.mouseDownBind = this.mousedown.bind(this);
    }

    componentDidMount() {
        if ('alt' in window) {
            alt.on('parseMod', this.parseMod.bind(this));
            alt.on('parseColors', this.parseColors.bind(this));
        } else {
            // JSON Mimic for Editing
            const list = JSON.parse(json);
            list.forEach(l => this.parseMod(JSON.stringify(l)));
        }
    }

    parseColors(colors) {
        console.log('Hello World');

        console.log(JSON.stringify(colors));

        this.setState({
            primary: colors.primary.color,
            secondary: colors.secondary.color,
            primaryPaintType: colors.primary.type,
            secondaryPaintType: colors.secondary.type
        });
    }

    parseMod(mod) {
        this.setState({
            mods: [...this.state.mods, JSON.parse(mod)]
        });
    }

    saveVehicle() {
        if ('alt' in window) {
            alt.emit('vehicle:SaveChanges');
        }
    }

    exit() {
        if ('alt' in window) {
            alt.emit('vehicle:Exit');
        }
    }

    setItemValue(index, increment) {
        let mods = [...this.state.mods];

        if (increment) {
            let shifted = mods[index].modLabels.shift();
            mods[index].modLabels.push(shifted);
        } else {
            let popped = mods[index].modLabels.pop();
            mods[index].modLabels.unshift(popped);
        }

        this.sendModification(mods[index].index, mods[index].modLabels[0].index);
        this.setState({ mods });
    }

    sendModification(index, value) {
        alt.emit('vehicle:UpdateLocalVehicle', {
            modType: index,
            modIndex: value
        });
    }

    showColorPopup(e, boolValue, isPrimary) {
        //console.log(`Values : ${boolValue}, ${isPrimary}`);

        if (boolValue) {
            window.addEventListener('mousedown', this.mouseDownBind);
        } else {
            window.removeEventListener('mousedown', this.mouseDownBind);
        }

        // need to handle two types of paint types here
        if (isPrimary) {
            this.setState({
                colorPopout: boolValue,
                primaryPaintType: parseInt(e.target.value),
                isPrimary
            });
        } else {
            this.setState({
                colorPopout: boolValue,
                secondaryPaintType: parseInt(e.target.value),
                isPrimary
            });
        }
    }

    colorR(e) {
        this.setColor(0, parseInt(e.target.value));
    }

    colorG(e) {
        this.setColor(1, parseInt(e.target.value));
    }

    colorB(e) {
        this.setColor(2, parseInt(e.target.value));
    }

    setColor(index, value) {
        if (this.state.isPrimary) {
            let primary = [...this.state.primary];
            primary[index] = value;
            this.setState({ primary });
        } else {
            let secondary = [...this.state.secondary];
            secondary[index] = value;
            this.setState({ secondary });
        }

        if ('alt' in window) {
            alt.emit(
                'vehicle:UpdateColor',
                this.state.primaryPaintType,
                this.state.secondaryPaintType,
                this.state.primary,
                this.state.secondary
            );
        } else {
            console.log(`Primary: ${this.state.primary}`);
            console.log(`Secondary: ${this.state.secondary}`);
        }
    }

    mousedown(e) {
        if (e.target.id === 'colorpopout' || e.target.parentNode.id === 'colorpopout')
            return;
        this.showColorPopup(e, false);
    }

    render() {
        return h(
            'div',
            { id: 'app' },
            h('div', { class: 'tab' }, h('h1', { class: 'title' }, 'Customize Vehicle')),
            h(
                'div',
                { class: 'mod-list scroll' },
                h(ModList, {
                    mods: this.state.mods,
                    setItemValue: this.setItemValue.bind(this),
                    showColorPopup: this.showColorPopup.bind(this),
                    primaryPaintType: this.state.primaryPaintType,
                    secondaryPaintType: this.state.secondaryPaintType
                })
            ),
            h(
                'div',
                { class: 'footer' },
                h(
                    'button',
                    { class: 'footer-button', onclick: this.exit.bind(this) },
                    'Exit'
                ),
                h(
                    'button',
                    { class: 'footer-button', onclick: this.saveVehicle.bind(this) },
                    'Purchase'
                )
            ),
            this.state.colorPopout &&
                h(
                    'div',
                    { class: 'colorpopout' },
                    h(
                        'div',
                        { class: 'mod', id: 'colorpopout' },
                        h(ColorBox, {
                            isPrimary: this.state.isPrimary,
                            primary: this.state.primary,
                            secondary: this.state.secondary
                        }),
                        h('input', {
                            class: 'red',
                            type: 'range',
                            min: 0,
                            max: 255,
                            value: this.state.isPrimary
                                ? this.state.primary[0]
                                : this.state.secondary[0],
                            oninput: this.colorR.bind(this)
                        }),
                        h('input', {
                            class: 'green',
                            type: 'range',
                            min: 0,
                            max: 255,
                            value: this.state.isPrimary
                                ? this.state.primary[1]
                                : this.state.secondary[1],
                            oninput: this.colorG.bind(this)
                        }),
                        h('input', {
                            class: 'blue',
                            type: 'range',
                            min: 0,
                            max: 255,
                            value: this.state.isPrimary
                                ? this.state.primary[2]
                                : this.state.secondary[2],
                            oninput: this.colorB.bind(this)
                        })
                        // You can put them in here as well.
                    )
                )
        );
    }
}

const ColorBox = ({ isPrimary, primary, secondary }) => {
    const color = isPrimary ? primary : secondary;
    const bgColor = `${color[0]}, ${color[1]}, ${color[2]}`;

    return h('div', {
        class: 'colorBox',
        style: `background-color: rgb(${bgColor}); `
    });
};

const ModList = ({
    mods,
    setItemValue,
    purchase,
    showColorPopup,
    primaryPaintType,
    secondaryPaintType
}) => {
    const itemList = mods.map((item, index) =>
        h(ModItem, { index, item, setItemValue, purchase })
    );

    // Need to inject it into itemList.
    // The css is setup in a way that the itemList controls how
    // everything looks.
    return h(
        'div',
        null,
        h(ColorSelect, {
            title: 'PrimaryColor',
            showColorPopup,
            isPrimary: true,
            paintType: primaryPaintType
        }),
        h(ColorSelect, {
            title: 'SecondaryColor',
            showColorPopup,
            isPrimary: false,
            paintType: secondaryPaintType
        }),
        itemList
    );
};

const ColorSelect = ({ title, showColorPopup, isPrimary, paintType }) => {
    showPopup = e => {
        showColorPopup(e, true, isPrimary);
    };

    return h(
        'div',
        { class: 'mod' },
        h('h4', null, title),
        h(
            'select',
            { oninput: showPopup.bind(this), value: `${paintType}` },
            h('option', { value: '0' }, 'Normal'),
            h('option', { value: '1' }, 'Metallic'),
            h('option', { value: '2' }, 'Pearl'),
            h('option', { value: '3' }, 'Matte'),
            h('option', { value: '4' }, 'Metal'),
            h('option', { value: '5' }, 'Chrome'),
            h('option', { value: '6', disabled: true }, 'Change Type')
        )
    );
};

// Items to Display in a Group
const ModItem = ({ index, item, setItemValue }) => {
    left = () => {
        setItemValue(index, false);
    };
    right = () => {
        setItemValue(index, true);
    };
    buymod = () => {
        purchase(index);
    };

    return h(
        'div',
        { class: 'mod' },
        h(
            'div',
            { class: 'spacer-left' },
            h('div', { class: 'title' }, `${item.slotName}`),
            h('div', { class: 'title' }, `${item.modLabels[0].displayName}`)
        ),
        h(
            'div',
            { class: 'spacer-right' },
            h(
                'button',
                {
                    class: 'left button',
                    onclick: this.left.bind(this)
                },
                '-'
            ),
            h(
                'button',
                {
                    class: 'right button',
                    onclick: this.right.bind(this)
                },
                '+'
            )
        )
    );
};

render(h(App), document.querySelector('#render'));

document.addEventListener('keyup', key => {
    if (key.key === 'Escape') {
        alt.emit('vehicle:Exit');
    }
});

function ready() {
    if ('alt' in window) {
        alt.emit('vehicle:FetchModList');
    }
}
